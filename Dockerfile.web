# Build stage
FROM node:22-bookworm-slim AS builder

WORKDIR /app

# Install pnpm and git
RUN npm install -g pnpm@10.10.0 && apt-get update && apt-get install -y git

# Clone the frontend repo with submodules
RUN git clone --depth 1 --recurse-submodules https://github.com/revoltchat/frontend.git .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build stoat.js dependency first
RUN pnpm --filter stoat.js run build

# Build solid-livekit-components
RUN pnpm --filter solid-livekit-components run build || true

# Build the client
RUN pnpm --filter client exec vite build

# Production stage - serve with Caddy
FROM caddy:2-alpine

# Copy built files
COPY --from=builder /app/packages/client/dist /srv

# Caddy config for SPA
RUN echo ':80 { \
    root * /srv \
    encode gzip \
    try_files {path} /index.html \
    file_server \
}' > /etc/caddy/Caddyfile

EXPOSE 80
