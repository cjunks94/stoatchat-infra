# Build stage
FROM node:22-bookworm-slim AS builder

WORKDIR /app

# Install pnpm and git
RUN npm install -g pnpm@10.10.0 && apt-get update && apt-get install -y git

# Clone the frontend repo (our fork) with submodules
RUN git clone --depth 1 --recurse-submodules https://github.com/cjunks94/revolt-frontend.git .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Setup fallback assets (script auto-detects empty submodule and uses fallback)
RUN pnpm --filter client exec node scripts/copyAssets.mjs

# Build workspace dependencies in order
RUN pnpm --filter stoat.js run build
RUN pnpm --filter solid-livekit-components run build || true

# Build lingui-solid packages (macro first, then extract-messages which depends on it)
RUN pnpm --filter "@lingui-solid/babel-plugin-lingui-macro" run build
RUN pnpm --filter "@lingui-solid/babel-plugin-extract-messages" run build

# Generate panda CSS
RUN pnpm --filter client run prepare

# Extract and compile i18n catalogs (lingui)
RUN pnpm --filter client exec lingui extract
RUN pnpm --filter client exec lingui compile --typescript

# Build the client (increase heap size for large build)
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Set API URLs for your instance
ARG VITE_API_URL=https://chat.cjunker.dev/api
ARG VITE_WS_URL=wss://chat.cjunker.dev/ws
ARG VITE_MEDIA_URL=https://chat.cjunker.dev/autumn
ARG VITE_PROXY_URL=https://chat.cjunker.dev/january
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_WS_URL=$VITE_WS_URL
ENV VITE_MEDIA_URL=$VITE_MEDIA_URL
ENV VITE_PROXY_URL=$VITE_PROXY_URL

RUN pnpm --filter client exec vite build

# Production stage - serve with Caddy
FROM caddy:2-alpine

# Copy built files
COPY --from=builder /app/packages/client/dist /srv

# Caddy config for SPA
RUN printf ':80 {\n\troot * /srv\n\tencode gzip\n\ttry_files {path} /index.html\n\tfile_server\n}\n' > /etc/caddy/Caddyfile

EXPOSE 80
