# Build stage
FROM node:22-bookworm-slim AS builder

WORKDIR /app

# Install pnpm and git
RUN npm install -g pnpm@10.10.0 && apt-get update && apt-get install -y git

# Clone the frontend repo (our fork) with submodules
RUN git clone --depth 1 --recurse-submodules https://github.com/cjunks94/revolt-frontend.git .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Setup fallback assets (script auto-detects empty submodule and uses fallback)
RUN pnpm --filter client exec node scripts/copyAssets.mjs

# Build workspace dependencies in order
RUN pnpm --filter stoat.js run build
RUN pnpm --filter solid-livekit-components run build || true
RUN pnpm --filter "@lingui-solid/babel-plugin-extract-messages" run build || true
RUN pnpm --filter "@lingui-solid/babel-plugin-lingui-macro" run build || true

# Generate panda CSS
RUN pnpm --filter client run prepare

# Compile i18n catalogs (lingui)
RUN pnpm --filter client exec lingui compile

# Build the client
RUN pnpm --filter client exec vite build

# Production stage - serve with Caddy
FROM caddy:2-alpine

# Copy built files
COPY --from=builder /app/packages/client/dist /srv

# Caddy config for SPA
RUN echo ':80 { \
    root * /srv \
    encode gzip \
    try_files {path} /index.html \
    file_server \
}' > /etc/caddy/Caddyfile

EXPOSE 80
